<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Дорожная карта проекта</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #F8FFFF;
      color: #2A5A5A;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(75,174,167,0.13);
      margin-top: 32px;
      padding: 24px 2vw 18px 2vw;
      width: 98vw;
      max-width: 100vw;
    }
    h2 {
      color: #4BAEA7;
      margin-bottom: 18px;
      text-align: center;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
      justify-content: flex-end;
    }
    .btn {
      background: #4BAEA7;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover { background: #368e8a; }
    .roadmap-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .roadmap-stage {
      background: #f8f8f8;
      border-radius: 10px;
      margin-bottom: 16px;
      padding: 16px 12px 12px 12px;
      box-shadow: 0 2px 8px rgba(75,174,167,0.07);
      position: relative;
    }
    .stage-header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .stage-header input[type="text"] {
      font-size: 1.1em;
      font-weight: 600;
      border: none;
      background: transparent;
      border-bottom: 1.5px solid #bbb;
      width: 140px;
      margin-right: 8px;
    }
    .stage-header input[type="date"] {
      border-radius: 6px;
      border: 1px solid #bbb;
      padding: 4px 8px;
      font-size: 1em;
    }
    .stage-header .btn-sm {
      padding: 4px 10px;
      font-size: 0.95em;
      margin-left: 4px;
    }
    .tasks {
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .task-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .task-item input[type="text"] {
      flex: 1;
      border-radius: 6px;
      border: 1px solid #bbb;
      padding: 4px 8px;
    }
    .calendar {
      margin: 24px 0 12px 0;
      background: #f8f8f8;
      border-radius: 12px;
      padding: 16px;
      overflow-x: auto;
    }
    .calendar-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 320px;
    }
    .calendar-table th, .calendar-table td {
      border: 1px solid #e0e0e0;
      padding: 6px 0;
      text-align: center;
      min-width: 32px;
      font-size: 0.98em;
    }
    .calendar-table .stage-day {
      background: #b2e6e2;
      border-radius: 6px;
    }
    @media (max-width: 600px) {
      .container { padding: 8px 2px; }
      .calendar { padding: 4px; }
      .roadmap-stage { padding: 8px 4px; }
    }
    .gantt-wrapper {
      display: flex;
      overflow-x: auto;
      border-radius: 12px;
      background: #f8f8f8;
      margin-top: 18px;
      min-height: 640px;
      width: 100%;
      max-width: 100vw;
    }
    .gantt-left {
      min-width: 260px;
      border-right: 1.5px solid #e0e0e0;
      padding: 0 0 0 8px;
      background: #f8f8f8;
      z-index: 2;
    }
    .gantt-right {
      flex: 1;
      overflow-x: auto;
      position: relative;
      background: #fff;
      padding-bottom: 12px;
      z-index: 1;
    }
    .gantt-row {
      display: flex;
      align-items: center;
      height: 64px;
      border-bottom: 1px solid #e0e0e0;
    }
    .gantt-label {
      font-size: 1em;
      padding: 0 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .gantt-bar {
      position: absolute;
      height: 44px;
      background: #4BAEA7;
      border-radius: 6px;
      opacity: 0.85;
      z-index: 3;
      color: #fff;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      padding-left: 6px;
    }
    .gantt-day-header {
      font-size: 0.95em;
      color: #888;
      text-align: center;
      height: 28px;
      border-bottom: 1.5px solid #e0e0e0;
      background: #f0f0f0;
    }
    .gantt-day-cell {
      width: 32px;
      height: 64px;
      border-right: 1px solid #e0e0e0;
      box-sizing: border-box;
      position: relative;
      background: #fff;
    }
    .gantt-day-cell.weekend {
      background: #ececec !important;
    }
    .gantt-vertical-weekend {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 32px;
      background: #ececec;
      z-index: 1;
      pointer-events: none;
    }
    .gantt-bar-task {
      background: #229ED9;
    }
    .gantt-label-indent {
      margin-left: 18px;
    }
    .gantt-executor {
      display: inline-block;
      background: #fff;
      color: #4BAEA7;
      border-radius: 50%;
      border: 1.5px solid #4BAEA7;
      width: 22px;
      height: 22px;
      text-align: center;
      font-size: 0.95em;
      margin-left: 6px;
      line-height: 22px;
    }
    .gantt-table {
      border-collapse: collapse;
      table-layout: fixed;
      background: #fff;
      min-width: 0;
    }
    .gantt-table th, .gantt-table td {
      border: 1px solid #e0e0e0;
      text-align: center;
      font-size: 1.1em;
      padding: 0;
      height: 54px;
      min-width: 54px;
      max-width: 54px;
      overflow: hidden;
      white-space: nowrap;
    }
    .gantt-table th.month {
      background: #f0f0f0;
      font-weight: 600;
      font-size: 1.15em;
      height: 38px;
    }
    .gantt-table th.weekend, .gantt-table td.weekend {
      background: #ececec !important;
    }
    .gantt-table th.dayname {
      background: #f8f8f8;
      font-size: 1.05em;
      color: #888;
    }
    .gantt-table th.daynum {
      background: #fff;
      font-size: 1.1em;
      font-weight: 500;
    }
    .gantt-table th.daynum.today {
      background: #4BAEA7 !important;
      color: #fff !important;
      font-weight: 700;
      border-radius: 8px;
      border: none !important;
      box-shadow: 0 2px 8px #4BAEA733;
      z-index: 3;
      transition: background 0.2s;
    }
    .gantt-table th.label, .gantt-table td.label {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #f8f8f8;
      min-width: 350px;
      max-width: 500px;
      width: 350px;
      white-space: normal;
      word-break: break-word;
      box-shadow: 2px 0 4px -2px #e0e0e0;
      padding: 10px 12px 10px 16px;
      vertical-align: top;
      text-align: left;
      border-right: 1.5px solid #e0e0e0;
    }
    .gantt-table th.responsible, .gantt-table td.responsible {
      position: sticky;
      left: 350px;
      z-index: 2;
      background: #f8f8f8;
      min-width: 340px;
      max-width: 340px;
      width: 340px;
      white-space: normal;
      word-break: break-word;
      padding: 10px 12px 10px 12px !important;
      vertical-align: top;
      text-align: left;
      border-right: 1.5px solid #e0e0e0;
      font-size: 1.04em;
      color: #256a6a;
      font-weight: 500;
      box-sizing: border-box;
    }
    .gantt-table th.responsible {
      font-weight: 700;
      background: #f8f8f8;
      box-sizing: border-box;
    }
    .gantt-table td.responsible {
      font-weight: 500;
      background: #fafdff;
      box-sizing: border-box;
    }
    .milestone-title {
      font-size: 1.35em;
      font-weight: 700;
      color: #256a6a;
      margin-bottom: 6px;
      line-height: 1.25;
      word-break: break-word;
      text-align: left;
      padding-left: 0;
      min-width: 200px;
      max-width: 480px;
      width: 100%;
      display: block;
    }
    .responsible-select, .task-responsible-select {
      background: none;
      border: none;
      color: #4BAEA7;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      min-width: 220px;
      max-width: 480px;
      width: 100%;
      padding: 2px 0 2px 0;
      outline: none;
      box-shadow: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      transition: color 0.2s;
      text-align: left;
    }
    .responsible-select:focus, .task-responsible-select:focus {
      color: #229ED9;
      outline: none;
      box-shadow: none;
    }
    .responsible-select option, .task-responsible-select option {
      color: #256a6a;
    }
    .gantt-task-row td.label { background: #fafdff; border-top: 1px solid #e0e0e0; text-align: left; }
    .gantt-task-row td.responsible { background: #fafdff; border-top: 1px solid #e0e0e0; text-align: right; }
    .gantt-task-row .task-text { font-size: 0.95em; font-weight: 400; color: #256a6a; text-align: left; }
    .gantt-task-row { border-bottom: none; }
    .edit-mode .edit-controls { display: inline-block !important; }
    .edit-controls { display: none; margin-right: 8px; }
    .edit-controls .add-stage-btn {
      background: none; color: #27ae60; border: none; border-radius: 0; width: auto; height: auto; font-size: 1.3em; cursor: pointer; margin: 0 8px 0 0; padding: 0 4px 0 0; vertical-align: middle;
    }
    .edit-controls .add-stage-btn:hover { color: #229ED9; background: none; }
    .delete-mode .delete-btn { display: inline-block !important; }
    .delete-btn { display: none; background: none; color: #dc3545; border: none; border-radius: 0; width: auto; height: auto; font-size: 1.2em; cursor: pointer; margin: 0 8px 0 0; padding: 0 4px 0 0; vertical-align: middle; }
    .delete-btn:hover { color: #fff; background: none; text-shadow: 0 0 2px #dc3545; }
    .draggable-row { cursor: grab; }
    .drag-over { background: #e6f2f2 !important; }
    .btn-table { background: #4BAEA7; color: #fff; border: none; border-radius: 8px; margin-bottom: 0; box-shadow: none; transition: background 0.2s; }
    .btn-table:hover { background: #229ED9; }
    .table-btn-row { display: flex; gap: 8px; margin-top: 4px; }
    .btn-table { background: #4BAEA7; color: #fff; border: none; border-radius: 8px; margin-bottom: 0; box-shadow: none; transition: background 0.2s; min-width: 70px; padding: 4px 10px; font-size: 0.98em; }
    .btn-table:hover { background: #229ED9; }
    .task-list { margin: 4px 0 0 32px; padding: 0; list-style: none; }
    .task-item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    .task-text {
      font-size: 0.92em;
      color: #256a6a;
      background: none;
      border: none;
      outline: none;
      min-width: 60px;
      font-weight: 400;
      padding-left: 0;
      margin-left: 8px;
    }
    .task-edit { background: none; border: none; color: #27ae60; font-size: 1.1em; cursor: pointer; padding: 0 4px; }
    .task-edit:hover { color: #229ED9; }
    .task-delete { background: none; border: none; color: #dc3545; font-size: 1.1em; cursor: pointer; padding: 0 4px; }
    .task-delete:hover { color: #fff; background: none; text-shadow: 0 0 2px #dc3545; }
    #roadmap-toast {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      min-width: 320px;
      max-width: 90vw;
      padding: 28px 38px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px #4BAEA755;
      font-size: 1.35em;
      font-weight: 600;
      color: #229ED9;
      text-align: center;
      letter-spacing: 0.01em;
      opacity: 0.97;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Дорожная карта проекта</h2>
    <div class="actions" style="flex:1; justify-content: flex-end; display: flex; gap: 12px; margin-bottom: 18px;">
      <button class="btn" onclick="loadTemplate()">Загрузить типовую</button>
      <button class="btn" onclick="saveRoadmap()">Сохранить</button>
    </div>
    <div class="gantt-wrapper">
      <table class="gantt-table" id="ganttTable">
        <thead id="ganttThead"></thead>
        <tbody id="ganttTbody"></tbody>
      </table>
    </div>
  </div>
  <div id="roadmap-toast" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;min-width:320px;max-width:90vw;padding:28px 38px;background:#fff;border-radius:18px;box-shadow:0 8px 32px #4BAEA755;font-size:1.35em;font-weight:600;color:#229ED9;text-align:center;letter-spacing:0.01em;opacity:0.97;"></div>
  <script>
    // --- Данные ---
    let stages = [];
    window.editStagesMode = false;
    window.deleteStagesMode = false;
    window.toggleEditStages = function() {
      window.editStagesMode = !window.editStagesMode;
      window.deleteStagesMode = false;
      document.body.classList.toggle('edit-mode', window.editStagesMode);
      document.body.classList.remove('delete-mode');
      renderGantt();
    }
    window.toggleDeleteStages = function() {
      window.deleteStagesMode = !window.deleteStagesMode;
      window.editStagesMode = false;
      document.body.classList.toggle('delete-mode', window.deleteStagesMode);
      document.body.classList.remove('edit-mode');
      renderGantt();
    }
    function getEmployeesList() {
      try {
        const arr = JSON.parse(localStorage.getItem('employees') || '[]');
        if (Array.isArray(arr) && arr.length > 0) {
          return arr.map(e => e.name).filter(Boolean);
        }
      } catch(e) {}
      return [];
    }
    function loadTemplate() {
      stages = [
        {name: 'Брифинг', start: '', end: '', tasks: ['Задача'], meeting: null},
        {name: 'Прототип', start: '', end: '', tasks: ['Задача'], meeting: null},
        {name: 'Дизайн', start: '', end: '', tasks: ['Задача'], meeting: null},
        {name: 'Верстка', start: '', end: '', tasks: ['Задача'], meeting: null},
        {name: 'Наполнение', start: '', end: '', tasks: ['Задача'], meeting: null},
        {name: 'Тестирование', start: '', end: '', tasks: ['Задача'], meeting: null},
        {name: 'Запуск', start: '', end: '', tasks: ['Задача'], meeting: null},
      ];
      renderGantt();
    }
    function addStage() {
      stages.push({name: 'Новый этап', start: '', end: '', tasks: [], meeting: null});
      renderGantt();
    }
    function removeStage(idx) {
      stages.splice(idx, 1);
      renderGantt();
    }
    function addTask(idx) {
      stages[idx].tasks.push('');
      renderGantt();
    }
    function removeTask(stageIdx, taskIdx) {
      stages[stageIdx].tasks.splice(taskIdx, 1);
      renderGantt();
    }
    function updateStageField(idx, field, value) {
      stages[idx][field] = value;
      renderGantt();
    }
    function updateTask(stageIdx, taskIdx, value) {
      stages[stageIdx].tasks[taskIdx] = value;
    }
    function openMeetingForm(idx) {
      const date = prompt('Дата встречи (ГГГГ-ММ-ДД):');
      if (!date) return;
      const time = prompt('Время встречи (чч:мм):');
      if (!time) return;
      const type = prompt('Тип встречи (созвон/онлайн/офлайн):');
      if (!type) return;
      stages[idx].meeting = {date, time, type};
      renderGantt();
    }
    function removeMeeting(idx) {
      stages[idx].meeting = null;
      renderGantt();
    }
    function saveRoadmap() {
      localStorage.setItem('roadmap', JSON.stringify(stages));
      window.editStagesMode = false;
      window.deleteStagesMode = false;
      document.body.classList.remove('edit-mode');
      document.body.classList.remove('delete-mode');
      renderGantt();
      showRoadmapToast('Дорожная карта сохранена!');
    }
    function showRoadmapToast(msg) {
      const toast = document.getElementById('roadmap-toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      toast.style.opacity = '0.97';
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(()=>{ toast.style.display = 'none'; }, 400);
      }, 1500);
    }
    // --- Gantt ---
    function renderGantt() {
      const thead = document.getElementById('ganttThead');
      const tbody = document.getElementById('ganttTbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      // --- Календарь на 1.5 года ---
      const now = new Date();
      const startYear = now.getFullYear();
      const startMonth = 0; // Январь
      const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      endDate.setMonth(endDate.getMonth() + 18);
      const endYear = endDate.getFullYear();
      const endMonth = endDate.getMonth();
      const monthsCount = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
      const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
      const weekDays = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
      // --- Считаем дни ---
      let days = [];
      for (let m = 0; m < monthsCount; m++) {
        const y = startYear + Math.floor((startMonth + m) / 12);
        const mo = (startMonth + m) % 12;
        const daysInMonth = new Date(y, mo + 1, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const date = new Date(y, mo, d);
          days.push({
            year: y,
            month: mo,
            day: d,
            monthName: monthNames[mo],
            weekday: weekDays[(date.getDay()+6)%7],
            isWeekend: ((date.getDay()+6)%7)>=5
          });
        }
      }
      // --- Динамическая ширина: показывать столько недель, сколько помещается в окно ---
      function setGanttWidth() {
        const cellWidth = 54; // px
        const labelWidth = 220;
        const windowW = window.innerWidth || document.documentElement.clientWidth;
        // Вычитаем отступы, кнопки и т.д. (примерно 80px)
        const freeW = Math.max(windowW - 80, 320);
        // Сколько дней влезает?
        let daysVisible = Math.floor((freeW - labelWidth) / cellWidth);
        // Округляем до целого числа недель
        daysVisible = Math.max(7, Math.floor(daysVisible / 7) * 7);
        // Если мало места — хотя бы 1 неделя
        if (daysVisible < 7) daysVisible = 7;
        const visibleWidth = labelWidth + daysVisible * cellWidth;
        document.querySelector('.gantt-wrapper').style.width = visibleWidth + 'px';
        document.getElementById('ganttTable').style.minWidth = (labelWidth + days.length * cellWidth) + 'px';
        document.getElementById('ganttTable').style.width = (labelWidth + days.length * cellWidth) + 'px';
      }
      setGanttWidth();
      window.addEventListener('resize', setGanttWidth);
      // --- Первая строка: месяц/год ---
      let monthRow = '<tr><th class="label"></th><th class="responsible"></th>';
      let i = 0;
      while (i < days.length) {
        const cur = days[i];
        let span = 1;
        while (i+span < days.length && days[i+span].month === cur.month && days[i+span].year === cur.year) span++;
        monthRow += `<th class="month" colspan="${span}">${cur.monthName} ${cur.year}</th>`;
        i += span;
      }
      monthRow += '</tr>';
      // --- Вторая строка: день недели ---
      let weekRow = '<tr>';
      weekRow += '<th class="label">Веха/Задача</th>';
      weekRow += '<th class="responsible">Ответственный</th>';
      days.forEach(d => weekRow += `<th class="dayname${d.isWeekend?' weekend':''}">${d.weekday}</th>`);
      weekRow += '</tr>';
      // --- Третья строка: число ---
      const today = new Date();
      let dayRow = '<tr>';
      dayRow += '<th class="label"><div class="table-btn-row"><button class="btn btn-table" onclick="window.toggleEditStages()">добавить</button>'
        + '<button class="btn btn-table" onclick="window.toggleDeleteStages()">удалить</button></div></th>';
      dayRow += '<th class="responsible"></th>';
      days.forEach(d => {
        const isToday = d.year === today.getFullYear() && d.month === today.getMonth() && d.day === today.getDate();
        dayRow += `<th class="daynum${d.isWeekend?' weekend':''}${isToday?' today':''}">${d.day}</th>`;
      });
      dayRow += '</tr>';
      thead.innerHTML = monthRow + weekRow + dayRow;
      // --- Дорожки ---
      window.addStageAt = function(idx) {
        stages.splice(idx+1, 0, {name: 'Новый этап', start: '', end: '', tasks: [], meeting: null});
        renderGantt();
      }
      window.deleteStageAt = function(idx) {
        stages.splice(idx, 1);
        renderGantt();
      }
      // Drag & drop
      let dragSrcIdx = null;
      function handleDragStart(e, idx) {
        dragSrcIdx = idx;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', idx);
        e.target.classList.add('draggable-row');
      }
      function handleDragOver(e, idx) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
        e.currentTarget.classList.add('drag-over');
      }
      function handleDrop(e, idx) {
        e.preventDefault();
        const from = dragSrcIdx;
        const to = idx;
        if (from !== null && to !== null && from !== to) {
          const moved = stages.splice(from, 1)[0];
          stages.splice(to, 0, moved);
          renderGantt();
        }
        dragSrcIdx = null;
        document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
      }
      function handleDragEnd(e) {
        dragSrcIdx = null;
        document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
      }
      stages.forEach((stage, idx) => {
        // --- Веха ---
        let tr = `<tr draggable="${window.editStagesMode}" ondragstart="handleDragStart(event,${idx})" ondragover="handleDragOver(event,${idx})" ondrop="handleDrop(event,${idx})" ondragend="handleDragEnd(event)"${window.editStagesMode?' class="draggable-row"':''}>`;
        tr += `<td class="label">
          <div class="milestone-title" style="margin-bottom:0;display:flex;align-items:center;gap:6px;">
            ${window.editStagesMode ? `<span class="edit-controls"><button class="add-stage-btn" title="Добавить веху" onclick="addStageAt(${idx});event.stopPropagation();">+</button></span>` : ''}
            ${window.deleteStagesMode ? `<button class="delete-btn" title="Удалить веху" onclick="deleteStageAt(${idx});event.stopPropagation();">×</button>` : ''}
            <span class='gantt-editable' data-idx='${idx}' ${window.editStagesMode?'contenteditable="true" onblur="updateStageField('+idx+',\'name\',this.textContent);renderGantt();"':''}>${stage.name}</span>
          </div>
        </td>`;
        const employeesList = getEmployeesList();
        tr += `<td class="responsible" style="vertical-align: middle;">
          <select data-idx="${idx}" class="responsible-select">
            <option value="">—</option>
            ${employeesList.map(emp => `<option value="${emp}"${stage.executor===emp?' selected':''}>${emp}</option>`).join('')}
          </select>
        </td>`;
        const today = new Date();
        days.forEach((d, dIdx) => {
          tr += `<td class="${d.isWeekend?'weekend':''}"></td>`;
        });
        tr += '</tr>';
        tbody.innerHTML += tr;
        // --- Задачи ---
        (stage.tasks||[]).forEach((task, tIdx) => {
          let taskTr = `<tr class="gantt-task-row">`;
          taskTr += `<td class="label" style="padding-left:38px;">
            <span style="font-size:0.95em;font-weight:400;color:#256a6a;">${tIdx+1}. </span><span class="task-text" onclick="window.editTaskText(this,${idx},${tIdx})" style="font-size:0.95em;font-weight:400;color:#256a6a;">${task}</span>
            ${window.deleteStagesMode ? `<button class="task-delete" title="Удалить задачу" onclick="window.deleteTaskFromStage(${idx},${tIdx});event.stopPropagation();">×</button>` : ''}
          </td>`;
          taskTr += `<td class="responsible">
            <select data-idx="${idx}" data-task-idx="${tIdx}" class="task-responsible-select">
              <option value="">—</option>
              ${getEmployeesList().map(emp => `<option value="${emp}"${stage.tasksExecutors&&stage.tasksExecutors[tIdx]===emp?' selected':''}>${emp}</option>`).join('')}
            </select>
          </td>`;
          days.forEach((d, dIdx) => {
            taskTr += `<td class="${d.isWeekend?'weekend':''}"></td>`;
          });
          taskTr += '</tr>';
          tbody.innerHTML += taskTr;
        });
        // Кнопка добавить задачу
        if (window.editStagesMode) {
          let addTaskTr = `<tr><td class="label" style="padding-left:38px;">`;
          addTaskTr += `<button class="task-edit" style="font-size:0.92em;padding:2px 8px;color:#4BAEA7;" onclick="window.addTaskToStage(${idx});event.stopPropagation();">добавить задачу</button>`;
          addTaskTr += `</td><td class="responsible"></td>`;
          days.forEach((d, dIdx) => { addTaskTr += `<td></td>`; });
          addTaskTr += '</tr>';
          tbody.innerHTML += addTaskTr;
        }
      });
      // --- Обработчик выбора ответственного ---
      document.querySelectorAll('.responsible-select').forEach(sel => {
        sel.onchange = function() {
          const idx = +sel.getAttribute('data-idx');
          stages[idx].executor = sel.value;
          renderGantt();
        };
      });
      // --- Обработчик выбора ответственного для задачи ---
      document.querySelectorAll('.task-responsible-select').forEach(sel => {
        sel.onchange = function() {
          const idx = +sel.getAttribute('data-idx');
          const tIdx = +sel.getAttribute('data-task-idx');
          if (!stages[idx].tasksExecutors) stages[idx].tasksExecutors = [];
          stages[idx].tasksExecutors[tIdx] = sel.value;
          renderGantt();
        };
      });
      // --- Автоскролл к сегодняшнему дню ---
      setTimeout(() => {
        const today = new Date();
        const todayIdx = days.findIndex(d => d.year === today.getFullYear() && d.month === today.getMonth() && d.day === today.getDate());
        if (todayIdx !== -1) {
          const cellWidth = 54;
          const labelWidth = 220;
          const wrapper = document.querySelector('.gantt-wrapper');
          const visibleWidth = wrapper.offsetWidth;
          const scrollLeft = Math.max(0, labelWidth + todayIdx * cellWidth - visibleWidth / 2 + cellWidth / 2);
          wrapper.scrollLeft = scrollLeft;
        }
      }, 0);
    }
    // --- Инициализация ---
    if (localStorage.getItem('roadmap')) {
      stages = JSON.parse(localStorage.getItem('roadmap'));
    } else {
      loadTemplate();
    }
    renderGantt();
    window.addTaskToStage = function(stageIdx) {
      if (!Array.isArray(stages[stageIdx].tasks)) stages[stageIdx].tasks = [];
      stages[stageIdx].tasks.push('Новая задача');
      renderGantt();
    }
    window.deleteTaskFromStage = function(stageIdx, taskIdx) {
      stages[stageIdx].tasks.splice(taskIdx, 1);
      renderGantt();
    }
    window.updateTaskInStage = function(stageIdx, taskIdx, value) {
      stages[stageIdx].tasks[taskIdx] = value;
    }
    window.editTaskText = function(span, stageIdx, taskIdx) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = stages[stageIdx].tasks[taskIdx];
      input.className = 'task-text';
      input.style.fontSize = '0.92em';
      input.style.marginLeft = '8px';
      input.onblur = function() {
        window.updateTaskInStage(stageIdx, taskIdx, input.value);
        renderGantt();
      };
      input.onkeydown = function(ev) {
        if (ev.key === 'Enter') {
          window.updateTaskInStage(stageIdx, taskIdx, input.value);
          renderGantt();
        }
      };
      span.replaceWith(input);
      input.focus();
    }
  </script>
</body>
</html>